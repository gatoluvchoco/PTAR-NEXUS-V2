<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PTAR Nexus | Library Smart Digital Process</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              nexus: {
                bg: '#0f1016', // Deep dark background
                card: '#181926', // Card background
                purple: '#8b5cf6',
                pink: '#ec4899',
                green: '#10b981',
                red: '#ef4444',
                yellow: '#f59e0b',
                blue: '#3b82f6'
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out forwards',
              'slide-up': 'slideUp 0.4s ease-out forwards',
              'pulse-slow': 'pulse 3s infinite',
              'scale-in': 'scaleIn 0.3s ease-out forwards',
              'bar-grow': 'barGrow 1s ease-out forwards',
              'slide-in-left': 'slideInLeft 0.3s ease-out forwards',
              'float': 'float 3s ease-in-out infinite',
              'glow': 'glow 2s ease-in-out infinite alternate',
              'blink': 'blink 4s infinite',
              'scan': 'scan 2s ease-in-out infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              scaleIn: {
                '0%': { opacity: '0', transform: 'scale(0.9)' },
                '100%': { opacity: '1', transform: 'scale(1)' },
              },
              barGrow: {
                '0%': { height: '0%' },
                '100%': { height: 'var(--target-height)' },
              },
              slideInLeft: {
                '0%': { transform: 'translateX(100%)', opacity: '0' },
                '100%': { transform: 'translateX(0)', opacity: '1' },
              },
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-10px)' },
              },
              glow: {
                'from': { boxShadow: '0 0 10px #8b5cf6, 0 0 20px #8b5cf6' },
                'to': { boxShadow: '0 0 20px #ec4899, 0 0 30px #ec4899' },
              },
              blink: {
                '0%, 48%, 52%, 100%': { transform: 'scaleY(1)' },
                '50%': { transform: 'scaleY(0.1)' },
              },
              scan: {
                '0%': { top: '0%', opacity: '0.8' },
                '50%': { top: '90%', opacity: '1' },
                '100%': { top: '0%', opacity: '0.8' }
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        /* background-color: #0f1016; handled by tailwind classes */
        -webkit-tap-highlight-color: transparent;
      }
      .scrollbar-hide::-webkit-scrollbar {
          display: none;
      }
      .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      /* Improved Touch Scrolling for Mobile */
      .touch-scroll {
        -webkit-overflow-scrolling: touch;
      }
      
      /* Card Flip Utils */
      .perspective-1000 {
        perspective: 1000px;
      }
      .transform-style-3d {
        transform-style: preserve-3d;
      }
      .backface-hidden {
        backface-visibility: hidden;
      }
      .rotate-y-180 {
        transform: rotateY(180deg);
      }
    </style>
</head>
<body class="bg-gray-100 dark:bg-[#0f1016] text-slate-800 dark:text-white transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Utils ---
        // Returns YYYY-MM-DD for Input values
        const getISODate = (addDays = 0) => {
            const d = new Date();
            d.setDate(d.getDate() + addDays);
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };

        // Returns dd/mm/yyyy for Display text
        const formatDateDisplay = (isoDate) => {
            if (!isoDate) return '';
            const [year, month, day] = isoDate.split('-');
            return `${day}/${month}/${year}`;
        };
        
        const GENERIC_COVER = "https://images.unsplash.com/photo-1543002588-bfa74002ed7e?auto=format&fit=crop&q=80&w=300";

        // --- Data ---
        const studentDatabase = {
            "2024441674": "AFFIE HAFIZAN KHAN BIN ALIJAN KHAN",
            "2024442374": "AMIRA SYAHAIREEN BINTI SAHDAN",
            "2024267258": "ANDRYSHA NYCHELLE ANAK ANDREW",
            "2024427454": "ARSYAD ZULHUSMI BIN KADAI",
            "2024298694": "BIJANI ANAK BAKAR",
            "2024436676": "CASYLVIA ANN ANAK ARMSTRONG",
            "2024436998": "DEAN DE DVINE JITEK",
            "2024206888": "DELLIA SUNGGAU ANAK DONNY",
            "2024670846": "EDIANA ANAK KAMIL",
            "2024223492": "ESTER AWANG",
            "2024288588": "FERGUSON QIUN ANAK LUTA",
            "2024212352": "HANIS YASMIN BINTI HARDYNORHAN",
            "2024419286": "HASNA NAZIRA BINTI AHMAD ROSALLAN",
            "2024204868": "HAZEL ANAK RITCHIE",
            "2024229294": "JAYCARLSON WILSON",
            "2024630652": "JUANA MIRACLE MICHAEL",
            "2024299304": "LORIA MANYIE ANAK NAWONG",
            "2024206946": "LUQMAN NURHAKIM OMARSHARIFF",
            "2024419516": "MOHAMAD ZAINORAZIEM BIN ZAINAL",
            "2024436008": "MOHAMMAD SYAHRIL AZLIE",
            "2024681454": "MOHD AMIRUL HAFIZ BIN ILAH",
            "2024282012": "MUHAMAD HAZIM AKMAL BIN JAMAN",
            "2024411696": "MUHAMMAD AFIQ HAIQAL BIN MOHD ROSDI",
            "2024645246": "NA'IM ANIQ BIN BASRI",
            "2024299084": "NUR AYUNI BINTI SEPAWI",
            "2024244202": "NUR QAMARINA BINTI UZILA",
            "2024200648": "NUR SYAZA ADRIANA BINTI HASMAN",
            "2024427272": "NURFARAH AININ SOFIYA BINTI MAJELAN",
            "2024207026": "NURUL FARAHANA BINTI ABDULLAH",
            "2024223252": "NURUL FATIHAH",
            "2024433328": "REBECCA RUDANG ANAK TIMOTHY",
            "2024604928": "REUBEN JAMES DEALWIS",
            "2024236022": "SITI ZAHIDAH BINTI MOHD RONIE",
            "2024696532": "WAHDANIA AYUMIE ANATASYA"
        };

        const ResourceType = {
          PHYSICAL: 'Physical Book',
          EBOOK: 'E-Book',
          THESIS: 'Thesis (IR)',
          JOURNAL: 'e-Journal',
          PAPER: 'Exam Paper (EQPS)',
          DATABASE: 'Online Database'
        };

        const Genre = {
            ALL: 'All Resources',
            TECH: 'Technology',
            BUSINESS: 'Business',
            FICTION: 'Fiction',
            SCIENCE: 'Science',
            HISTORY: 'History',
            LAW: 'Law',
            ART: 'Art & Design'
        };

        // Source Categories
        const SourceCategory = {
            ALL: 'ALL',
            UITM_PHYSICAL: 'UITM_PHYSICAL',
            UITM_DIGITAL: 'UITM_DIGITAL',
            GLOBAL: 'GLOBAL'
        };

        // --- Inventory Data ---
        // ADDED SUMMARIES HERE
        const localPhysicalInventory = [
            { id: 'local_1', source: SourceCategory.UITM_PHYSICAL, title: 'Management of Digital Transformation', author: 'Dr. Marlita Mad Yusuf', year: 2024, type: ResourceType.PHYSICAL, genre: Genre.BUSINESS, shelfLocation: 'Level 2, Aisle 4, Shelf B', callNumber: 'HD30.2 .M37 2024', availability: 'Available', coverImage: 'https://covers.openlibrary.org/b/isbn/9783030880362-M.jpg', summary: 'This comprehensive guide explores the strategies, challenges, and opportunities of digital transformation in modern business environments, offering practical frameworks for leaders.' },
            { id: 'local_11', source: SourceCategory.UITM_PHYSICAL, title: 'Malaysian Economy: Past, Present & Future', author: 'Prof. Jomo K.S.', year: 2020, type: ResourceType.PHYSICAL, genre: Genre.BUSINESS, shelfLocation: 'Level 1, Aisle 2, Shelf F', callNumber: 'HC445.5 .J66 2020', availability: 'Available', coverImage: 'https://m.media-amazon.com/images/I/51a3kK8+l+L._AC_UF1000,1000_QL80_.jpg', summary: 'A comprehensive economic analysis of Malaysia, tracing its development from independence to the present day and offering projections for future growth.' },
            { id: 'local_30', source: SourceCategory.UITM_PHYSICAL, title: 'Principles of Marketing', author: 'Philip Kotler', year: 2021, type: ResourceType.PHYSICAL, genre: Genre.BUSINESS, shelfLocation: 'Level 2, Aisle 5', callNumber: 'HF5415 .K63 2021', availability: 'Available', coverImage: 'https://covers.openlibrary.org/b/isbn/9780133795028-M.jpg', summary: 'The gold standard textbook for marketing students, covering fundamental concepts, modern marketing strategies, and consumer behavior analysis.' },
            { id: 'local_5', source: SourceCategory.UITM_PHYSICAL, title: 'Clean Code', author: 'Robert C. Martin', year: 2008, type: ResourceType.PHYSICAL, genre: Genre.TECH, shelfLocation: 'Level 3, Aisle 1, Shelf A', callNumber: 'QA76.76 .C65 M37', availability: 'On Loan', coverImage: 'https://covers.openlibrary.org/b/isbn/9780132350884-M.jpg', summary: 'A handbook of agile software craftsmanship, providing best practices for writing clean, maintainable, and efficient code.' },
            { id: 'local_14', source: SourceCategory.UITM_PHYSICAL, title: 'Artificial Intelligence: A Modern Approach', author: 'Stuart Russell', year: 2020, type: ResourceType.PHYSICAL, genre: Genre.TECH, shelfLocation: 'Level 4, Aisle 12', callNumber: 'Q335 .R86 2020', availability: 'Available', coverImage: 'https://covers.openlibrary.org/b/isbn/9780134610993-M.jpg', summary: 'The leading textbook in Artificial Intelligence, offering a broad and deep exploration of AI concepts, from search algorithms to machine learning.' },
            { id: 'local_88', source: SourceCategory.UITM_PHYSICAL, title: 'Malaysian Legal System', author: 'Ashgar Ali Ali Mohamed', year: 2022, type: ResourceType.PHYSICAL, genre: Genre.LAW, shelfLocation: 'Level 3, Law Section, Aisle 4', callNumber: 'KPG68 .M35 2022', availability: 'Available', coverImage: 'https://m.media-amazon.com/images/I/51+eUoQyvBL._AC_UF1000,1000_QL80_.jpg', summary: 'An authoritative guide to the Malaysian legal system, detailing its history, structure, and key legal principles for law students and practitioners.' },
            { id: 'local_89', source: SourceCategory.UITM_PHYSICAL, title: 'Civil Engineering Materials', author: 'Somayaji Shan', year: 2018, type: ResourceType.PHYSICAL, genre: Genre.TECH, shelfLocation: 'Level 4, Eng Section', callNumber: 'TA403 .S66 2018', availability: 'On Loan', coverImage: 'https://covers.openlibrary.org/b/isbn/9780130839060-M.jpg', summary: 'Covers the properties and applications of materials used in civil engineering, including concrete, steel, timber, and asphalt.' },
            { id: 'local_90', source: SourceCategory.UITM_PHYSICAL, title: 'Introduction to Graphic Design', author: 'Chip Kidd', year: 2020, type: ResourceType.PHYSICAL, genre: Genre.ART, shelfLocation: 'Level 5, Art & Design', callNumber: 'NC997 .K53 2020', availability: 'Available', coverImage: 'https://covers.openlibrary.org/b/isbn/9781523516559-M.jpg', summary: 'A visual guide to the fundamentals of visual communication, typography, and layout design for aspiring graphic designers.' },
            { id: 'local_91', source: SourceCategory.UITM_PHYSICAL, title: 'Organic Chemistry', author: 'Paula Yurkanis Bruice', year: 2019, type: ResourceType.PHYSICAL, genre: Genre.SCIENCE, shelfLocation: 'Level 4, Science Wing', callNumber: 'QD251.3 .B78 2019', availability: 'Available', coverImage: 'https://covers.openlibrary.org/b/isbn/9780134042282-M.jpg', summary: 'Essential textbook for chemistry undergraduates, focusing on the structure, reactivity, and synthesis of organic compounds.' },
            { id: 'local_92', source: SourceCategory.UITM_PHYSICAL, title: 'Macroeconomics', author: 'N. Gregory Mankiw', year: 2021, type: ResourceType.PHYSICAL, genre: Genre.BUSINESS, shelfLocation: 'Level 2, Business Wing', callNumber: 'HB172.5 .M36 2021', availability: 'Available', coverImage: 'https://covers.openlibrary.org/b/isbn/9781319105990-M.jpg', summary: 'Explains the principles of macroeconomics, including inflation, unemployment, and economic growth, with real-world examples.' },
            { id: 'local_93', source: SourceCategory.UITM_PHYSICAL, title: 'Research Methodology', author: 'Ranjit Kumar', year: 2019, type: ResourceType.PHYSICAL, genre: Genre.SCIENCE, shelfLocation: 'Level 1, General', callNumber: 'Q180.55 .K86 2019', availability: 'Available', coverImage: 'https://covers.openlibrary.org/b/isbn/9781446269976-M.jpg', summary: 'A step-by-step guide for beginners in research, covering the research process, data collection methods, and analysis techniques.' }
        ];

        const localDigitalInventory = [
            { id: 'db_1', source: SourceCategory.UITM_DIGITAL, title: 'IEEE Xplore Digital Library', author: 'IEEE', year: '2024', type: ResourceType.DATABASE, genre: Genre.TECH, availability: 'PTAR Digital', coverImage: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/IEEE_logo.svg/300px-IEEE_logo.svg.png', summary: 'Access to over 5 million documents from IEEE journals, transactions, and conference proceedings in electrical engineering and computer science.', url: 'https://ieeexplore.ieee.org/' },
            { id: 'db_2', source: SourceCategory.UITM_DIGITAL, title: 'ScienceDirect', author: 'Elsevier', year: '2024', type: ResourceType.DATABASE, genre: Genre.SCIENCE, availability: 'PTAR Digital', coverImage: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/ScienceDirect_logo.svg/300px-ScienceDirect_logo.svg.png', summary: 'Leading full-text scientific database offering journal articles and book chapters from more than 2,500 peer-reviewed journals.', url: 'https://www.sciencedirect.com/' },
            { id: 'db_3', source: SourceCategory.UITM_DIGITAL, title: 'UiTM EQPS (Exam Question Papers)', author: 'UiTM Exams', year: '2023', type: ResourceType.PAPER, genre: Genre.ALL, availability: 'PTAR Digital', coverImage: 'https://img.icons8.com/clouds/200/exam.png', summary: 'An official repository of past year examination question papers from all faculties of Universiti Teknologi MARA.', url: 'https://eqps.uitm.edu.my/' },
            { id: 'db_4', source: SourceCategory.UITM_DIGITAL, title: 'UiTM Institutional Repository (IR)', author: 'UiTM Scholars', year: '2024', type: ResourceType.THESIS, genre: Genre.ALL, availability: 'PTAR Digital', coverImage: 'https://img.icons8.com/clouds/200/thesis.png', summary: 'Open access digital collection of theses, dissertations, and research publications authored by UiTM staff and students.', url: 'https://ir.uitm.edu.my/' },
            { id: 'db_5', source: SourceCategory.UITM_DIGITAL, title: 'Emerald Insight', author: 'Emerald Publishing', year: '2024', type: ResourceType.JOURNAL, genre: Genre.BUSINESS, availability: 'PTAR Digital', coverImage: 'https://upload.wikimedia.org/wikipedia/en/thumb/0/07/Emerald_Publishing.svg/1200px-Emerald_Publishing.svg.png', summary: 'Provides access to high-quality journals and case studies in business, management, economics, and social sciences.', url: 'https://www.emerald.com/insight/' },
            { id: 'db_6', source: SourceCategory.UITM_DIGITAL, title: 'NST Digital Archive', author: 'New Straits Times', year: '2024', type: ResourceType.DATABASE, genre: Genre.HISTORY, availability: 'PTAR Digital', coverImage: 'https://assets.nst.com.my/images/nst-logo_1614138622.png', summary: 'A comprehensive digital archive of Malaysian news, history, and events as reported by the New Straits Times.', url: 'https://www.nst.com.my/' },
            { id: 'db_7', source: SourceCategory.UITM_DIGITAL, title: 'LawNet Malaysia', author: 'PNMB', year: '2024', type: ResourceType.DATABASE, genre: Genre.LAW, availability: 'PTAR Digital', coverImage: 'https://img.icons8.com/clouds/200/law.png', summary: 'The authoritative source of laws of Malaysia, including acts, enactments, and ordinances, updated regularly.', url: 'https://www.lawnet.com.my/' }
        ];

        // --- Components ---

        // 1. LoginScreen
        const LoginScreen = ({ onLogin }) => {
            const [id, setId] = useState('');
            const [userType, setUserType] = useState('student'); // 'student' or 'lecturer'
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                setTimeout(() => { 
                    if (userType === 'lecturer') {
                        // Lecturer specific login
                        if (id === '241791') {
                            onLogin({
                                name: "Marlita Mat Yusof",
                                studentId: id,
                                department: 'Faculty of Business Management',
                                avatarUrl: 'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&q=80&w=200', // Professional Photo
                                role: 'Lecturer'
                            });
                        } else {
                            setError("Invalid Lecturer ID. Please try 241791.");
                            setIsLoading(false);
                        }
                    } else {
                        // Student Login
                        const studentName = studentDatabase[id] || "Student User"; 
                        onLogin({
                            name: studentName,
                            studentId: id,
                            department: 'Faculty of Business Management',
                            avatarUrl: 'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?auto=format&fit=crop&q=80&w=200', // Animal Photo (Cat)
                            role: 'Student'
                        });
                    }
                }, 800);
            };

            return (
                <div className="min-h-[100dvh] flex items-center justify-center relative p-4 overflow-hidden">
                     <div 
                        className="absolute inset-0 z-0 bg-cover bg-center bg-no-repeat"
                        style={{
                            backgroundImage: 'url("https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=2070&auto=format&fit=crop")',
                            filter: 'blur(8px)',
                            transform: 'scale(1.1)'
                        }}
                     ></div>
                     <div className="absolute inset-0 z-0 bg-black/60 dark:bg-black/70"></div>

                     <div className="relative z-10 w-full max-w-sm p-8 bg-white/90 dark:bg-[#181926]/90 backdrop-blur-md border border-gray-200 dark:border-white/5 rounded-3xl shadow-2xl animate-fade-in">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-gradient-to-tr from-purple-600 to-pink-500 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-purple-900/40">
                                <i className="fa-solid fa-layer-group text-3xl text-white"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 dark:text-white mb-1"><span className="text-slate-800 dark:text-white">PTAR</span> <span className="text-purple-600 dark:text-purple-400">NEXUS</span></h1>
                            <p className="text-slate-500 dark:text-slate-400 text-sm">Sign in to your digital library</p>
                        </div>

                        {/* Login Type Toggle */}
                        <div className="flex p-1 bg-gray-100 dark:bg-black/40 rounded-xl mb-6 border border-gray-200 dark:border-white/5">
                            <button 
                                onClick={() => setUserType('student')} 
                                className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${userType === 'student' ? 'bg-white dark:bg-[#232433] shadow-md text-purple-600' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                            >
                                Student
                            </button>
                            <button 
                                onClick={() => setUserType('lecturer')} 
                                className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${userType === 'lecturer' ? 'bg-white dark:bg-[#232433] shadow-md text-purple-600' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                            >
                                Lecturer
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">{userType === 'student' ? 'Student ID' : 'Lecturer ID / Staff ID'}</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i className={`fa-solid ${userType === 'student' ? 'fa-id-card' : 'fa-user-tie'} text-slate-400 dark:text-slate-500`}></i>
                                    </div>
                                    <input type="text" required value={id} onChange={(e) => setId(e.target.value)} className="w-full bg-slate-50 dark:bg-[#232433] border border-gray-200 dark:border-white/5 rounded-xl py-3 pl-10 pr-4 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-600 focus:outline-none focus:border-purple-500 transition-colors" placeholder={userType === 'student' ? "e.g. 2024441674" : "e.g. 241791"} />
                                </div>
                            </div>
                            {error && (
                                <div className="text-red-500 dark:text-red-400 text-xs text-center animate-pulse">
                                    <i className="fa-solid fa-circle-exclamation mr-1"></i> {error}
                                </div>
                            )}
                            <button type="submit" disabled={isLoading} className="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 hover:opacity-90 text-white font-bold shadow-lg transition-all flex items-center justify-center gap-2 transform active:scale-95">
                                {isLoading ? <i className="fa-solid fa-spinner fa-spin"></i> : 'Sign In'}
                            </button>
                        </form>
                        <div className="mt-8 text-center space-y-2">
                            <p className="text-[10px] text-slate-500 dark:text-slate-600 uppercase tracking-wider">Authorized Access Only</p>
                            <p className="text-[10px] text-slate-600 dark:text-slate-700">Try: {userType === 'student' ? '2024441674' : '241791'}</p>
                        </div>
                     </div>
                </div>
            );
        };

        // 2. ResultCard
        const ResultCard = ({ result, isBorrowed, onBookClick, onToggleBorrow, onRead, idx }) => {
            const isPhysical = result.type === ResourceType.PHYSICAL;
            let badgeText = '';
            let badgeColor = '';
            
            if (result.source === SourceCategory.GLOBAL) {
                badgeText = '(Open Web)';
                badgeColor = 'bg-blue-500 text-white';
            } else if (result.source === SourceCategory.UITM_DIGITAL) {
                badgeText = 'Digital Archive';
                badgeColor = 'bg-pink-500 text-white';
            } else {
                badgeText = 'Physical';
                badgeColor = 'bg-amber-500 text-black';
            }

            const displayImage = (result.coverImage && result.coverImage !== 'placeholder') ? result.coverImage : GENERIC_COVER;

            return (
                <div 
                    className="flex bg-white dark:bg-[#1e2030] border border-gray-200 dark:border-white/5 rounded-xl overflow-hidden hover:border-purple-500/50 transition-all cursor-pointer group h-36 md:h-44 hover:shadow-lg hover:shadow-purple-900/10 hover:-translate-y-1" 
                    onClick={() => onBookClick(result)}
                    style={{ animationDelay: `${idx * 50}ms` }}
                >
                    <div className="w-24 md:w-32 relative bg-gray-200 dark:bg-black/20 flex-shrink-0 overflow-hidden">
                        <img src={displayImage} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy" onError={(e) => e.target.src=GENERIC_COVER} />
                        <span className={`absolute top-2 left-2 px-1.5 py-0.5 text-[8px] md:text-[10px] font-bold rounded shadow-md ${badgeColor}`}>
                            {badgeText}
                        </span>
                    </div>
                    <div className="flex-1 p-3 md:p-4 flex flex-col justify-between">
                        <div>
                            <div className="text-[9px] md:text-[10px] text-purple-600 dark:text-purple-400 font-bold uppercase mb-1 truncate">{result.genre}</div>
                            <h4 className="text-slate-800 dark:text-white font-bold text-xs md:text-sm leading-tight mb-1 line-clamp-2">{result.title}</h4>
                            <p className="text-slate-500 dark:text-slate-400 text-[10px] md:text-xs line-clamp-1">{result.author} â€¢ {result.year}</p>
                            {isPhysical && <div className="mt-2 flex items-center gap-1 text-[9px] md:text-[10px] text-amber-600 dark:text-amber-400"><i className="fa-solid fa-location-dot"></i> <span className="truncate">{result.shelfLocation}</span></div>}
                        </div>
                        <div className="flex gap-2 mt-2">
                            {isPhysical ? (
                                <button onClick={(e) => { e.stopPropagation(); onBookClick(result); }} className={`flex-1 py-1.5 text-[10px] md:text-xs font-medium rounded-lg transition-colors border border-gray-200 dark:border-white/5 ${isBorrowed ? 'bg-red-500/10 text-red-600 dark:text-red-300 border-red-500/30' : 'bg-slate-100 dark:bg-[#2a2b3d] hover:bg-slate-200 dark:hover:bg-white dark:hover:text-black text-slate-700 dark:text-white'}`}>
                                    {isBorrowed ? 'Manage Loan' : 'Borrow'}
                                </button>
                            ) : (
                                <button onClick={(e) => { e.stopPropagation(); onRead(result); }} className="flex-1 py-1.5 bg-purple-600/10 dark:bg-purple-600/20 hover:bg-purple-600 text-purple-700 dark:text-purple-300 hover:text-white text-[10px] md:text-xs font-medium rounded-lg transition-colors border border-purple-500/30">
                                    Read
                                </button>
                            )}
                            <button className="w-8 flex items-center justify-center text-slate-400 hover:text-pink-500 bg-slate-100 dark:bg-[#2a2b3d] rounded-lg border border-gray-200 dark:border-white/5"><i className="fa-regular fa-heart text-xs md:text-sm"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. DigitalID Widget - UPDATED: Removed validity date, updated text, added scanner animation
        const DigitalIDWidget = ({ user, onScan, enableScan = true }) => {
            const [isFlipped, setIsFlipped] = useState(false);
            const [isScanning, setIsScanning] = useState(false);

            const handleCardClick = () => {
                if (!enableScan) return; // Prevent flip if scan disabled
                setIsFlipped(!isFlipped);
            }

            const handleScan = (e) => {
                e.stopPropagation(); 
                if (isScanning || !enableScan) return;
                setIsScanning(true);
                setTimeout(() => {
                    setIsScanning(false);
                    onScan(); 
                }, 2000); // Increased duration slightly for effect
            };

            return (
                <div className="h-full flex flex-col gap-4 animate-fade-in">
                    {/* Access Card Container */}
                    <div 
                        className={`relative flex-1 rounded-3xl perspective-1000 group ${enableScan ? 'cursor-pointer' : ''}`}
                        onClick={handleCardClick}
                    >
                        <div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                            
                            {/* FRONT: Purple Digital Card */}
                            <div className="absolute inset-0 backface-hidden w-full h-full rounded-3xl bg-gradient-to-br from-purple-700 via-indigo-800 to-purple-900 border border-white/10 shadow-2xl p-6 flex flex-col justify-between overflow-hidden">
                                {/* Decorative Glows */}
                                <div className="absolute -top-10 -right-10 w-40 h-40 bg-purple-500/30 blur-3xl rounded-full"></div>
                                <div className="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/20 to-transparent"></div>

                                {/* Header */}
                                <div className="flex items-center gap-3 relative z-10">
                                    <div className="w-10 h-10 bg-white/10 backdrop-blur-md rounded-xl flex items-center justify-center border border-white/20">
                                        <i className="fa-solid fa-layer-group text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 className="text-white font-bold text-sm tracking-wide">PTAR NEXUS</h3>
                                        <p className="text-white/60 text-[10px] tracking-wider uppercase">Digital Access Card</p>
                                    </div>
                                </div>

                                {/* User Info */}
                                <div className="flex items-center gap-4 relative z-10 mt-2">
                                    <div className="w-16 h-16 rounded-2xl bg-purple-300/20 backdrop-blur-md flex items-center justify-center text-2xl font-bold text-white border border-white/10 overflow-hidden">
                                        {user.avatarUrl ? <img src={user.avatarUrl} className="w-full h-full object-cover" /> : user.name.charAt(0)}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <h2 className="text-white font-bold text-lg leading-tight truncate uppercase">{user.name}</h2>
                                        <p className="text-white/80 font-mono text-sm my-0.5">{user.studentId}</p>
                                        <span className="inline-block px-2 py-0.5 bg-emerald-500/20 border border-emerald-500/40 rounded text-[9px] font-bold text-emerald-400 uppercase tracking-wide">Active {user.role || 'Student'}</span>
                                    </div>
                                </div>

                                {/* Footer */}
                                <div className="flex justify-between items-end relative z-10 mt-4">
                                    <div>
                                        <p className="text-white/40 text-[9px] uppercase font-bold mb-0.5">Faculty</p>
                                        <p className="text-white text-xs font-medium max-w-[180px] leading-tight">{user.department}</p>
                                    </div>
                                    {/* Scan feature only if enabled */}
                                    <div className="text-right">
                                        {enableScan && (
                                            <>
                                                <p className="text-white/60 text-[10px] mb-1">Tap to Scan</p>
                                                <i className="fa-solid fa-qrcode text-white text-xl"></i>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* BACK: QR Code / Entry Pass */}
                            <div className="absolute inset-0 backface-hidden rotate-y-180 w-full h-full rounded-3xl bg-slate-100 dark:bg-white border border-gray-200 shadow-2xl p-6 flex flex-col items-center justify-center text-center">
                                <h3 className="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-4">Library Entry Pass</h3>
                                
                                {/* QR Code Area - Interactive now with Scanning Animation */}
                                <div 
                                    onClick={handleScan}
                                    className={`relative p-2 bg-white rounded-xl shadow-sm border border-gray-100 transition-transform active:scale-95 overflow-hidden ${isScanning ? 'ring-4 ring-purple-500/30' : 'hover:scale-105'}`}
                                >
                                    <img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${user.studentId}`} className={`w-28 h-28 ${isScanning ? 'opacity-30 blur-[1px]' : ''}`} />
                                    
                                    {/* Scanning Animation Overlay */}
                                    {isScanning && (
                                        <div className="absolute inset-0 z-10">
                                            {/* Moving Scanner Line */}
                                            <div className="absolute top-0 left-0 w-full h-[3px] bg-red-500 shadow-[0_0_15px_rgba(239,68,68,1)] animate-scan z-20"></div>
                                            {/* Scanner Field Effect */}
                                            <div className="absolute inset-0 bg-gradient-to-b from-red-500/10 to-transparent animate-scan" style={{animationDuration: '2s'}}></div>
                                            
                                            <div className="absolute inset-0 flex items-center justify-center z-30">
                                                <i className="fa-solid fa-spinner fa-spin text-purple-600 text-2xl drop-shadow-md"></i>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <p className="text-[9px] text-purple-500 font-bold mt-2 animate-pulse">{isScanning ? 'Scanning...' : 'Scan at The Library Kiosk'}</p>

                                <div className="mt-2 px-4 py-2 bg-slate-100 rounded-lg border border-slate-200">
                                    <p className="font-mono text-slate-800 font-bold text-lg tracking-wider">{user.studentId}</p>
                                </div>
                                <div className="w-full flex justify-between items-center mt-auto pt-2">
                                     {/* Removed Valid Until Date as requested */}
                                     <span></span> 
                                     <button className="text-[10px] text-slate-400 flex items-center gap-1 hover:text-purple-600 transition-colors">
                                        <i className="fa-solid fa-rotate"></i> Flip back
                                     </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        // 4. SmartBooking Widget
        const SmartBookingWidget = ({ rooms, onBookClick }) => {
            return (
                <div className="h-full flex flex-col animate-fade-in" style={{animationDelay: '100ms'}}>
                    <div className="flex justify-between items-center mb-4 px-1">
                        <div className="flex items-center gap-2">
                            <i className="fa-solid fa-people-roof text-purple-400"></i>
                            <span className="font-bold text-slate-800 dark:text-white text-sm">Smart Rooms</span>
                        </div>
                        <span className="text-[10px] px-2 py-0.5 bg-green-500/20 text-green-400 rounded border border-green-500/20 font-bold">Live Status</span>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pr-1 scrollbar-hide">
                        {rooms.map((room, idx) => (
                            <div key={room.id} className="bg-[#1e2030] border border-white/5 rounded-xl p-4 flex flex-col justify-between hover:border-purple-500/30 transition-all group min-h-[140px]">
                                <div className="flex justify-between items-start mb-2">
                                    <div className="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                                        <i className="fa-solid fa-screen-users"></i>
                                    </div>
                                    <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wide ${room.status === 'Available' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                        {room.status === 'Available' ? 'AVAILABLE' : 'OCCUPIED'}
                                    </span>
                                </div>
                                
                                <div className="mb-3">
                                    <h4 className="text-white font-bold text-sm mb-0.5">{room.name}</h4>
                                    <p className="text-slate-500 text-[10px]">{room.capacity} Pax Capacity</p>
                                </div>
                                
                                <div className="flex items-center gap-1.5 text-slate-400 border-t border-white/5 pt-2 mt-auto">
                                    <i className="fa-regular fa-clock text-[10px]"></i>
                                    <span className="text-[9px]">{room.status === 'Available' ? 'Ready for booking' : 'Next: 9:00 AM'}</span>
                                </div>
                                
                                <button 
                                    onClick={() => onBookClick(room)}
                                    className="absolute inset-0 w-full h-full cursor-pointer z-10"
                                ></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 5. Analytics Widget
        const AnalyticsWidget = () => {
            const data = [
                { label: 'Sci-Fi', val: 474, color: 'bg-[#a855f7]', h: 'h-24' },  // Purple
                { label: 'History', val: 543, color: 'bg-[#22c55e]', h: 'h-28' }, // Green
                { label: 'Tech', val: 355, color: 'bg-[#eab308]', h: 'h-16' },    // Yellow
                { label: 'Biz', val: 178, color: 'bg-[#f97316]', h: 'h-8' }       // Orange
            ];

            return (
                 <div className="bg-[#181926] border border-white/5 rounded-2xl p-6 h-full flex flex-col animate-fade-in" style={{animationDelay: '200ms'}}>
                    <div className="flex-1 flex items-end justify-between gap-4 px-2 pb-6">
                        {data.map((d, i) => (
                            <div key={i} className="flex flex-col items-center w-full gap-2 group">
                                <div className={`w-full ${d.h} rounded-t-lg ${d.color} opacity-90 hover:opacity-100 transition-all relative shadow-lg`}></div>
                                <div className="text-center">
                                    <span className="block text-white font-bold text-xs">{d.label}</span>
                                    <span className="block text-[10px] text-slate-500">{d.val} reads</span>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="border-t border-white/5 pt-4">
                        <div className="flex justify-between items-center mb-1">
                            <span className="text-slate-400 text-[10px] font-bold">Monthly Target</span>
                            <span className="text-white text-xs font-bold">85%</span>
                        </div>
                        <div className="w-full h-2 bg-slate-700/30 rounded-full overflow-hidden">
                            <div className="h-full w-[85%] bg-gradient-to-r from-purple-500 to-pink-500 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.4)]"></div>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Trending / Most Borrowed Widget
        const TrendingBooksWidget = ({ onBookClick }) => {
            const trending = [
                { id: 'local_1', title: 'Management of Digital Transformation', author: 'Dr. Marlita Mad Yusuf', count: 142, cover: 'https://covers.openlibrary.org/b/isbn/9783030880362-M.jpg', summary: 'This comprehensive guide explores the strategies, challenges, and opportunities of digital transformation in modern business environments.' },
                { id: 'local_88', title: 'Malaysian Legal System', author: 'Ashgar Ali Ali Mohamed', count: 98, cover: 'https://m.media-amazon.com/images/I/51+eUoQyvBL._AC_UF1000,1000_QL80_.jpg', summary: 'An authoritative guide to the Malaysian legal system, detailing its history, structure, and key legal principles.' },
                { id: 'local_30', title: 'Principles of Marketing', author: 'Philip Kotler', count: 86, cover: 'https://covers.openlibrary.org/b/isbn/9780133795028-M.jpg', summary: 'The gold standard textbook for marketing students, covering fundamental concepts, modern marketing strategies, and consumer behavior.' },
                { id: 'local_5', title: 'Clean Code', author: 'Robert C. Martin', count: 75, cover: 'https://covers.openlibrary.org/b/isbn/9780132350884-M.jpg', summary: 'A handbook of agile software craftsmanship, providing best practices for writing clean, maintainable, and efficient code.' },
                { id: 'local_93', title: 'Research Methodology', author: 'Ranjit Kumar', count: 68, cover: 'https://covers.openlibrary.org/b/isbn/9781446269976-M.jpg', summary: 'A step-by-step guide for beginners in research, covering the research process, data collection methods, and analysis techniques.' }
            ];

            return (
                <div className="bg-white dark:bg-[#181926] border border-gray-200 dark:border-white/5 rounded-2xl p-6 h-full flex flex-col animate-fade-in" style={{animationDelay: '300ms'}}>
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                            <i className="fa-solid fa-fire text-orange-500"></i>
                            <span className="font-bold text-slate-800 dark:text-white text-sm">Most Borrowed</span>
                        </div>
                        <button className="text-[10px] text-purple-600 dark:text-purple-400 font-bold hover:underline">View All</button>
                    </div>
                    <div className="flex gap-4 overflow-x-auto pb-2 scrollbar-hide">
                        {trending.map((book, idx) => (
                            <div key={idx} className="flex-shrink-0 w-28 group cursor-pointer" onClick={() => onBookClick(book)}>
                                <div className="w-28 h-40 rounded-lg overflow-hidden shadow-md mb-2 relative">
                                    <img src={book.cover} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"/>
                                    <div className="absolute top-1 right-1 bg-black/60 backdrop-blur-sm text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold flex items-center gap-1">
                                        <i className="fa-solid fa-download text-[7px]"></i> {book.count}
                                    </div>
                                </div>
                                <h4 className="text-xs font-bold text-slate-800 dark:text-white line-clamp-1 group-hover:text-purple-500 transition-colors">{book.title}</h4>
                                <p className="text-[10px] text-slate-500 line-clamp-1">{book.author}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // NEW: Campus News Widget
        const NewsFeedWidget = () => {
            const news = [
                { title: "UiTM Ranks Top 10 in QS Asia University Rankings 2024", source: "UiTM News Hub", time: "2h ago", image: "https://upload.wikimedia.org/wikipedia/commons/4/4e/UiTM_Shah_Alam_Gate.jpg" },
                { title: "KPT Announces New Student Aid Initiatives for B40", source: "Ministry of Higher Ed", time: "5h ago", image: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/Emblem_of_Malaysia.svg/800px-Emblem_of_Malaysia.svg.png" },
                { title: "PTAR Extends Operating Hours for Final Exam Week", source: "Library Announce", time: "1d ago", image: "https://library.uitm.edu.my/images/slider/2020/ptar_mobile.jpg" },
                { title: "Digital ID Implementation Succesful Across All Campuses", source: "TechToday", time: "1d ago", image: "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&q=80&w=1000" }
            ];

            return (
                 <div className="bg-white dark:bg-[#181926] border border-gray-200 dark:border-white/5 rounded-2xl p-6 h-full flex flex-col animate-fade-in" style={{animationDelay: '400ms'}}>
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                            <i className="fa-solid fa-newspaper text-blue-500"></i>
                            <span className="font-bold text-slate-800 dark:text-white text-sm">Campus News</span>
                        </div>
                        <a href="https://news.google.com/home?hl=en-MY&gl=MY&ceid=MY:en" target="_blank" className="text-[10px] text-blue-500 hover:text-blue-600 font-bold flex items-center gap-1">
                            Google News <i className="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-4 pr-1 scrollbar-hide">
                        {news.map((item, idx) => (
                            <a key={idx} href="https://news.google.com/home?hl=en-MY&gl=MY&ceid=MY:en" target="_blank" className="flex gap-3 group">
                                <div className="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden flex-shrink-0">
                                    <img src={item.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onError={(e) => e.target.src='https://placehold.co/100x100?text=News'} />
                                </div>
                                <div>
                                    <h4 className="text-xs font-bold text-slate-800 dark:text-white line-clamp-2 leading-snug group-hover:text-blue-500 transition-colors">{item.title}</h4>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="text-[9px] font-bold text-slate-500 uppercase">{item.source}</span>
                                        <span className="text-[9px] text-slate-400">â€¢ {item.time}</span>
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            );
        };

        // 6. Header Component
        const Header = ({ user, toggleMobileMenu, onOpenProfile, notifications, isOnline, toggleOnline, theme, toggleTheme, onToggleNotifications, showNotifPanel, allNotifications }) => {
            return (
                <header className="h-16 md:h-20 px-4 md:px-8 flex items-center justify-between border-b border-gray-200 dark:border-white/5 bg-gray-100 dark:bg-[#0f1016] animate-slide-up relative z-30 transition-colors">
                    <div className="flex items-center gap-4">
                        <button onClick={toggleMobileMenu} className="lg:hidden text-slate-800 dark:text-white text-xl">
                            <i className="fa-solid fa-bars"></i>
                        </button>
                        <div>
                            {/* Full Name Rendering */}
                            <h2 className="text-sm md:text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wide truncate max-w-[150px] md:max-w-none">Hi, <span className="text-purple-600 dark:text-purple-400">{user.name}</span></h2>
                            <p className="text-[10px] md:text-xs text-slate-500 hidden md:block">{user.department}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-3 md:gap-4">
                        {/* Dark/Light Mode Toggle */}
                        <button 
                            onClick={toggleTheme}
                            className="w-8 h-8 rounded-full bg-white dark:bg-[#181926] flex items-center justify-center text-slate-600 dark:text-yellow-400 border border-gray-200 dark:border-white/5 shadow-inner hover:scale-105 transition-transform"
                        >
                            <i className={`fa-solid ${theme === 'dark' ? 'fa-sun' : 'fa-moon'} text-xs`}></i>
                        </button>

                        {/* Online Status Toggle */}
                        <div 
                            onClick={toggleOnline}
                            className={`hidden md:flex px-3 py-1.5 rounded-full border items-center gap-2 shadow-inner cursor-pointer transition-colors select-none ${isOnline ? 'bg-white dark:bg-[#181926] border-green-500/30' : 'bg-red-50 dark:bg-red-900/10 border-red-500/30'}`}
                        >
                            <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                            <span className={`text-xs font-bold ${isOnline ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{isOnline ? 'Online' : 'Offline'}</span>
                        </div>

                        {/* Notifications (Clickable) */}
                        <div className="relative">
                            <div onClick={onToggleNotifications} className="cursor-pointer hover:scale-110 transition-transform relative">
                                <i className="fa-solid fa-bell text-slate-600 dark:text-slate-400 text-lg"></i>
                                {notifications.length > 0 && <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full text-[8px] flex items-center justify-center font-bold text-white animate-bounce">{notifications.length}</span>}
                            </div>
                            
                            {/* Notification History Panel */}
                            {showNotifPanel && (
                                <div className="absolute top-10 right-0 w-72 bg-white dark:bg-[#181926] border border-gray-200 dark:border-white/10 rounded-xl shadow-2xl z-50 animate-scale-in overflow-hidden">
                                    <div className="p-3 border-b border-gray-200 dark:border-white/5 bg-gray-50 dark:bg-black/20">
                                        <h4 className="text-xs font-bold text-slate-800 dark:text-white uppercase">Notification History</h4>
                                    </div>
                                    <div className="max-h-60 overflow-y-auto">
                                        {allNotifications.length === 0 ? (
                                            <div className="p-4 text-center text-xs text-slate-500">No notifications yet</div>
                                        ) : (
                                            allNotifications.map((n, i) => (
                                                <div key={i} className="p-3 border-b border-gray-100 dark:border-white/5 last:border-none hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                                                    <p className="text-xs text-slate-800 dark:text-white mb-1">{n.msg}</p>
                                                    <p className="text-[10px] text-slate-400">{n.time}</p>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Profile Pic */}
                        <div onClick={onOpenProfile} className="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-200 dark:bg-[#181926] border-2 border-purple-500 overflow-hidden cursor-pointer hover:scale-105 transition-transform hover:ring-2 ring-purple-500/50">
                             {user.avatarUrl ? <img src={user.avatarUrl} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-purple-600 flex items-center justify-center text-white font-bold">{user.name.charAt(0)}</div>}
                        </div>
                    </div>
                </header>
            );
        };

        // 7. Borrow and Return Section Modal (FIXED)
        const BorrowReturnModal = ({ book, isOpen, onClose, onBorrow, onReturn, onRenew, isBorrowed, borrowedDetails, user }) => {
            if (!isOpen || !book) return null;
            const isPhysical = book.type === ResourceType.PHYSICAL;
            const displayImage = (book.coverImage && book.coverImage !== 'placeholder') ? book.coverImage : GENERIC_COVER;

            const [courseCode, setCourseCode] = useState(borrowedDetails?.courseCode || '');
            const [returnDate, setReturnDate] = useState(borrowedDetails?.dueDate || getISODate(7));

            useEffect(() => {
                if(isOpen) {
                    if (isBorrowed && borrowedDetails) {
                        setCourseCode(borrowedDetails.courseCode || '');
                        setReturnDate(borrowedDetails.dueDate || getISODate(7));
                    } else {
                        setCourseCode('');
                        setReturnDate(getISODate(7));
                    }
                }
            }, [isOpen, isBorrowed, borrowedDetails]);

            const handleBorrowSubmit = () => {
                if(!courseCode.trim()) {
                    alert("Please enter a Course Code.");
                    return;
                }
                onBorrow(book, { courseCode, returnDate });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-[#181926] border border-gray-200 dark:border-white/10 rounded-2xl w-full max-w-lg shadow-2xl p-6 animate-scale-in max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">{isPhysical ? 'Borrow and Return Section' : 'Book Details'}</h3>
                            <button onClick={onClose}><i className="fa-solid fa-xmark text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors"></i></button>
                        </div>
                        <div className="bg-gray-50 dark:bg-[#232433] rounded-xl p-4 flex gap-4 mb-6 border border-gray-200 dark:border-white/5">
                            <img src={displayImage} className="w-16 h-24 object-cover rounded-md shadow-md" onError={(e) => e.target.src=GENERIC_COVER} />
                            <div>
                                <span className="text-[10px] text-slate-500 dark:text-slate-400 uppercase font-bold">{book.type}</span>
                                <h4 className="text-slate-800 dark:text-white font-bold mb-1 line-clamp-2">{book.title}</h4>
                                <p className="text-xs text-slate-500">{book.author}</p>
                            </div>
                        </div>
                        
                        <div className="space-y-4 mb-6">
                             <div className="p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-100 dark:border-purple-500/10">
                                <h5 className="text-xs font-bold text-purple-700 dark:text-purple-300 uppercase mb-1">Synopsis</h5>
                                <p className="text-xs text-slate-600 dark:text-slate-300 leading-relaxed max-h-40 overflow-y-auto">
                                    {book.summary || "No summary available for this resource."}
                                </p>
                             </div>
                        </div>

                        {/* Rendering Logic Inlined to Fix Babel/React Error */}
                        {!isPhysical && (
                            <div className="space-y-4">
                                <button onClick={() => { window.open(book.url || '#', '_blank'); onClose(); }} className="w-full py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold transition-colors shadow-lg shadow-purple-600/20">Read Now</button>
                            </div>
                        )}

                        {isPhysical && !isBorrowed && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-[10px] text-slate-400 font-bold uppercase block mb-1">Full Name</label>
                                        <input type="text" value={user.name} readOnly className="w-full bg-gray-100 dark:bg-[#0f1016] border border-gray-200 dark:border-white/10 rounded-lg p-3 text-sm text-slate-500 dark:text-slate-400 focus:outline-none cursor-not-allowed" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-slate-400 font-bold uppercase block mb-1">Course Code</label>
                                        <input type="text" value={courseCode} onChange={(e) => setCourseCode(e.target.value)} placeholder="e.g. CSC253" className="w-full bg-white dark:bg-[#232433] border border-gray-200 dark:border-white/10 rounded-lg p-3 text-sm text-slate-800 dark:text-white focus:outline-none focus:border-purple-500 transition-colors" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-[10px] text-slate-400 font-bold uppercase block mb-1">Borrowing Date</label>
                                        <div className="bg-gray-100 dark:bg-[#0f1016] border border-gray-200 dark:border-white/10 rounded-lg p-3 text-sm text-slate-700 dark:text-slate-300 flex items-center gap-2"><i className="fa-regular fa-calendar"></i> {formatDateDisplay(getISODate())}</div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-slate-400 font-bold uppercase block mb-1">Return Date</label>
                                        <input type="date" value={returnDate} min={getISODate(1)} onChange={(e) => setReturnDate(e.target.value)} className="w-full bg-white dark:bg-[#232433] border border-gray-200 dark:border-white/10 rounded-lg p-3 text-sm text-slate-800 dark:text-white focus:outline-none focus:border-purple-500 transition-colors" />
                                    </div>
                                </div>
                                
                                <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 flex gap-3 mt-2">
                                    <i className="fa-solid fa-circle-info text-blue-500 dark:text-blue-400 mt-0.5 text-xs"></i>
                                    <p className="text-[11px] text-blue-800 dark:text-blue-200 leading-tight">By borrowing this item, you agree to return it by the selected date. Fines apply for late returns.</p>
                                </div>
                                
                                <div className="flex justify-end gap-3 pt-2">
                                    <button onClick={onClose} className="px-4 py-3 rounded-xl text-sm font-bold text-slate-500 dark:text-slate-300 hover:text-slate-800 dark:hover:text-white transition-colors">Cancel</button>
                                    <button onClick={handleBorrowSubmit} className="px-8 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold shadow-lg shadow-purple-900/50 transition-colors">Confirm Borrow</button>
                                </div>
                            </div>
                        )}

                        {isPhysical && isBorrowed && (
                            <div className="space-y-6">
                                <div className="bg-green-500/10 border border-green-500/20 rounded-xl p-4">
                                <div className="flex items-center gap-2 mb-2 text-green-600 dark:text-green-400 text-xs font-bold uppercase tracking-wider">
                                    <i className="fa-solid fa-check-circle"></i> Currently Borrowed
                                </div>
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-slate-500 dark:text-slate-400 text-xs block">Course Code</span><span className="font-mono text-slate-800 dark:text-white font-bold">{borrowedDetails?.courseCode || 'N/A'}</span></div>
                                    <div><span className="text-slate-500 dark:text-slate-400 text-xs block">Due Date</span><span className="font-mono text-slate-800 dark:text-white font-bold">{formatDateDisplay(borrowedDetails?.dueDate) || 'N/A'}</span></div>
                                </div>
                                </div>

                                <div className="border-t border-gray-200 dark:border-white/5 pt-4">
                                <h4 className="text-sm font-bold text-slate-800 dark:text-white mb-3">Renewal Options</h4>
                                <div className="flex items-center justify-between bg-slate-50 dark:bg-[#232433] p-3 rounded-lg border border-gray-200 dark:border-white/5">
                                    <div>
                                        <p className="text-xs text-slate-800 dark:text-white font-bold">Extend for 7 Days</p>
                                        <p className="text-[10px] text-slate-500">New Due Date: <span className="text-purple-500">{formatDateDisplay(getISODate(7))}</span></p>
                                    </div>
                                    <button onClick={() => onRenew(book)} className="px-4 py-2 bg-purple-600/10 text-purple-600 dark:text-purple-400 hover:bg-purple-600 hover:text-white text-xs font-bold rounded-lg border border-purple-500/20 transition-all">Renew</button>
                                </div>
                                </div>

                                <div className="flex justify-end gap-3 pt-2">
                                <button onClick={() => onReturn(book)} className="w-full py-3 rounded-xl bg-red-500/10 text-red-600 dark:text-red-400 hover:bg-red-500 hover:text-white text-sm font-bold border border-red-500/20 transition-all">Return Book</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 8. Booking Detail Modal
        const BookingDetailModal = ({ room, user, isOpen, onClose, onConfirm }) => {
            if (!isOpen || !room) return null;
            const timeSlots = ["09:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM"];
            const [selectedSlot, setSelectedSlot] = useState("04:00 PM");
            const [bookingDate, setBookingDate] = useState("2026-01-13");
            const [purpose, setPurpose] = useState("Group Discussion");

            const occupiedSlots = ["12:00 PM"];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-[#181926] border border-white/10 rounded-2xl w-full max-w-md shadow-2xl animate-scale-in overflow-hidden">
                        <div className="p-6 border-b border-white/5 flex justify-between items-start">
                            <div>
                                <h3 className="text-lg font-bold text-white leading-tight">{room.name}</h3>
                                <p className="text-slate-400 text-xs">Capacity: {room.capacity} Pax</p>
                            </div>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400 hover:bg-white/10 transition-colors">
                                <i className="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        <div className="p-6 space-y-6">
                            <div className="bg-[#232433] rounded-xl p-4 flex items-center gap-4 border border-white/5">
                                <div className="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
                                    <i className="fa-solid fa-user text-purple-400"></i>
                                </div>
                                <div>
                                    <p className="text-[10px] text-slate-400 uppercase font-bold">Booking As</p>
                                    <h4 className="text-white text-xs font-bold line-clamp-1">{user?.name}</h4>
                                    <p className="text-slate-500 text-[10px] font-mono">{user?.studentId}</p>
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] text-slate-400 font-bold uppercase block mb-2">Select Date</label>
                                <div className="relative">
                                    <input 
                                        type="date" 
                                        value={bookingDate} 
                                        onChange={(e) => setBookingDate(e.target.value)}
                                        className="w-full bg-[#0f1016] border border-white/10 rounded-xl px-4 py-3 text-white text-sm focus:outline-none focus:border-purple-500 transition-colors"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] text-slate-400 font-bold uppercase block mb-2">Available Slots</label>
                                <div className="grid grid-cols-4 gap-2">
                                    {timeSlots.map(slot => {
                                        const isOccupied = occupiedSlots.includes(slot);
                                        const isSelected = selectedSlot === slot;
                                        
                                        let btnClass = "py-2 rounded-lg text-[10px] font-bold transition-all border ";
                                        if (isOccupied) {
                                            btnClass += "bg-red-500/5 text-red-500 border-red-500/20 cursor-not-allowed opacity-60";
                                        } else if (isSelected) {
                                            btnClass += "bg-red-900/20 text-red-400 border-red-500/50 shadow-[0_0_10px_rgba(239,68,68,0.2)]";
                                        } else {
                                            btnClass += "bg-[#232433] text-slate-400 border-white/5 hover:border-white/20 hover:text-white";
                                        }

                                        return (
                                            <button 
                                                key={slot} 
                                                disabled={isOccupied}
                                                onClick={() => setSelectedSlot(slot)} 
                                                className={btnClass}
                                            >
                                                {slot}
                                            </button>
                                        );
                                    })}
                                </div>
                                <div className="flex justify-end gap-3 mt-2">
                                    <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-green-500"></div><span className="text-[9px] text-slate-400">Selected</span></div>
                                    <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-slate-600"></div><span className="text-[9px] text-slate-400">Available</span></div>
                                    <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-red-500"></div><span className="text-[9px] text-slate-400">Occupied</span></div>
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] text-slate-400 font-bold uppercase block mb-2">Purpose</label>
                                <div className="relative">
                                    <select 
                                        value={purpose}
                                        onChange={(e) => setPurpose(e.target.value)}
                                        className="w-full bg-[#0f1016] border border-white/10 rounded-xl px-4 py-3 text-white text-sm appearance-none focus:outline-none focus:border-purple-500"
                                    >
                                        <option>Group Discussion</option>
                                        <option>Study Group</option>
                                        <option>Presentation Rehearsal</option>
                                        <option>Club Meeting</option>
                                    </select>
                                    <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 text-xs">
                                        <i className="fa-solid fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div className="p-6 pt-0 flex gap-4 mt-2">
                            <button onClick={onClose} className="flex-1 py-3 text-sm font-bold text-white hover:text-slate-300 transition-colors">Cancel</button>
                            <button onClick={() => onConfirm(room, selectedSlot)} className="flex-1 py-3 rounded-xl bg-[#7c3aed] hover:bg-[#6d28d9] text-white font-bold text-sm shadow-lg shadow-purple-900/40 transition-all">Confirm Booking</button>
                        </div>

                    </div>
                </div>
            );
        };
        
        // 9. Feedback Detail Modal
        const FeedbackModal = ({ isOpen, onClose, onSubmit }) => {
            if (!isOpen) return null;
            const [type, setType] = useState('Bug Report');
            const [desc, setDesc] = useState('');

            const handleSubmit = () => {
                onSubmit(type, desc);
                setDesc('');
                setType('Bug Report');
            };

            return (
                 <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-[#181926] border border-gray-200 dark:border-white/10 rounded-2xl w-full max-w-lg shadow-2xl p-6 animate-scale-in">
                         <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">System Feedback</h3>
                            <button onClick={onClose}><i className="fa-solid fa-xmark text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors"></i></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs text-slate-400 font-bold uppercase block mb-2">Feedback Type</label>
                                <div className="flex gap-2">
                                    {['Bug Report', 'Feature Request', 'Other'].map(t => (
                                        <button key={t} onClick={() => setType(t)} className={`px-4 py-2 rounded-lg text-xs font-bold border transition-all ${type === t ? 'bg-purple-600 text-white border-purple-500' : 'bg-slate-50 dark:bg-[#232433] text-slate-500 dark:text-slate-400 border-gray-200 dark:border-white/5'}`}>{t}</button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 font-bold uppercase block mb-2">Description</label>
                                <textarea value={desc} onChange={(e) => setDesc(e.target.value)} rows="4" className="w-full bg-slate-50 dark:bg-[#232433] border border-gray-200 dark:border-white/5 rounded-xl p-3 text-slate-800 dark:text-white text-sm focus:outline-none focus:border-purple-500" placeholder="Describe the issue or idea..."></textarea>
                            </div>
                            <button onClick={handleSubmit} className="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg transition-colors">Submit Feedback</button>
                        </div>
                    </div>
                 </div>
            );
        };

        // 10. Profile Modal - UPDATED HISTORY
        const ProfileModal = ({ user, isOpen, onClose }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-[#181926] border border-gray-200 dark:border-white/10 rounded-2xl w-full max-w-3xl shadow-2xl overflow-hidden animate-scale-in flex flex-col md:flex-row max-h-[90vh]">
                        <div className="w-full md:w-1/3 bg-gray-100 dark:bg-black/20 p-8 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-gray-200 dark:border-white/5">
                            <div className="w-32 h-32 rounded-full border-4 border-purple-500 mb-4 overflow-hidden shadow-2xl">
                                {user.avatarUrl ? <img src={user.avatarUrl} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-purple-600 flex items-center justify-center text-white font-bold text-3xl">{user.name.charAt(0)}</div>}
                            </div>
                            <h3 className="text-slate-800 dark:text-white font-bold text-center text-lg">{user.name}</h3>
                            <p className="text-purple-600 dark:text-purple-400 text-sm font-mono mt-1">{user.studentId}</p>
                            <span className="mt-4 px-3 py-1 bg-green-500/20 text-green-600 dark:text-green-400 text-xs font-bold rounded-full border border-green-500/30">Active Student</span>
                        </div>
                        <div className="flex-1 p-8 overflow-y-auto">
                             <div className="mb-8">
                                <h4 className="text-slate-800 dark:text-white font-bold mb-4 uppercase tracking-wider text-xs border-b border-gray-200 dark:border-white/10 pb-2">Student Details</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><p className="text-[10px] text-slate-500 uppercase">Department</p><p className="text-sm text-slate-700 dark:text-white">{user.department}</p></div>
                                    <div><p className="text-[10px] text-slate-500 uppercase">Semester</p><p className="text-sm text-slate-700 dark:text-white">03</p></div>
                                    <div className="col-span-2"><p className="text-[10px] text-slate-500 uppercase">Email</p><p className="text-sm text-slate-700 dark:text-white">{user.studentId}@student.uitm.edu.my</p></div>
                                </div>
                             </div>
                             
                             {/* Recent History Section - UPDATED */}
                             <div>
                                <h4 className="text-slate-800 dark:text-white font-bold mb-4 uppercase tracking-wider text-xs border-b border-gray-200 dark:border-white/10 pb-2">Activity History</h4>
                                <div className="space-y-3">
                                    {/* Borrowing Activity */}
                                    <div className="flex justify-between items-center text-sm p-3 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/5">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500">
                                                <i className="fa-solid fa-hand-holding-heart text-xs"></i>
                                            </div>
                                            <div>
                                                <span className="text-slate-500 dark:text-slate-400 text-xs block font-bold uppercase">Borrowing</span>
                                                <span className="text-slate-800 dark:text-white text-xs">The Pragmatic Programmer</span>
                                            </div>
                                        </div>
                                        <span className="text-[10px] text-slate-500">Today</span>
                                    </div>

                                    {/* Returns Activity */}
                                    <div className="flex justify-between items-center text-sm p-3 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/5">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-500">
                                                <i className="fa-solid fa-rotate-left text-xs"></i>
                                            </div>
                                            <div>
                                                <span className="text-slate-500 dark:text-slate-400 text-xs block font-bold uppercase">Return</span>
                                                <span className="text-slate-800 dark:text-white text-xs">Malaysian Legal System</span>
                                            </div>
                                        </div>
                                        <span className="text-[10px] text-slate-500">Yesterday</span>
                                    </div>

                                    {/* Reading Activity */}
                                    <div className="flex justify-between items-center text-sm p-3 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/5">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-500">
                                                <i className="fa-solid fa-book-open-reader text-xs"></i>
                                            </div>
                                            <div>
                                                <span className="text-slate-500 dark:text-slate-400 text-xs block font-bold uppercase">Reading</span>
                                                <span className="text-slate-800 dark:text-white text-xs">HBR: Digital Transformation</span>
                                            </div>
                                        </div>
                                        <span className="text-[10px] text-slate-500">3 Days ago</span>
                                    </div>
                                </div>
                             </div>

                             <button onClick={onClose} className="mt-8 w-full md:w-auto px-6 py-2 bg-gray-200 dark:bg-white/10 hover:bg-gray-300 dark:hover:bg-white/20 rounded-lg text-sm text-slate-800 dark:text-white transition-colors">Close Profile</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 11. Chatbot Widget
        const ChatbotWidget = () => {
             const [isOpen, setIsOpen] = useState(false);
             const [messages, setMessages] = useState([{text: "Hello! How can I help you today?", from: 'bot'}]);
             const [input, setInput] = useState("");
             
             const send = (e) => {
                 e.preventDefault();
                 if(!input) return;
                 setMessages([...messages, {text: input, from: 'user'}]);
                 setInput("");
                 setTimeout(() => {
                     setMessages(prev => [...prev, {text: "I can assist with book searches, room bookings, and account status.", from: 'bot'}]);
                 }, 1000);
             };

             return (
                    <div className={`fixed bottom-6 right-6 z-50 transition-all duration-300 ease-in-out ${isOpen ? 'w-80 h-96' : 'w-14 h-14'}`}>
                        {isOpen ? (
                            <div className="w-full h-full bg-white dark:bg-[#181926] border border-gray-200 dark:border-white/10 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up">
                                <div className="p-3 bg-gradient-to-r from-purple-600 to-indigo-600 flex justify-between items-center">
                                    <div className="flex items-center gap-2 text-white">
                                        <i className="fa-solid fa-robot"></i>
                                        <span className="font-bold text-sm">Nexus Bot</span>
                                    </div>
                                    <button onClick={() => setIsOpen(false)}><i className="fa-solid fa-xmark text-white"></i></button>
                                </div>
                                <div className="flex-1 p-3 overflow-y-auto space-y-2 bg-gray-50 dark:bg-[#0f1016]">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`text-xs p-2 rounded-lg max-w-[80%] animate-fade-in ${m.from === 'user' ? 'bg-purple-600 text-white ml-auto' : 'bg-white dark:bg-[#232433] text-slate-800 dark:text-slate-300 shadow-sm'}`}>{m.text}</div>
                                    ))}
                                </div>
                                <form onSubmit={send} className="p-2 border-t border-gray-200 dark:border-white/5 flex gap-2 bg-white dark:bg-[#181926]">
                                    <input value={input} onChange={e => setInput(e.target.value)} className="flex-1 bg-gray-100 dark:bg-[#232433] text-slate-800 dark:text-white text-xs p-2 rounded-lg border border-gray-200 dark:border-white/5 outline-none" placeholder="Type..." />
                                    <button type="submit" className="px-3 bg-purple-600 rounded-lg text-white"><i className="fa-solid fa-paper-plane text-xs"></i></button>
                                </form>
                            </div>
                        ) : (
                            <div onClick={() => setIsOpen(true)} className="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center relative shadow-lg shadow-indigo-500/50 animate-float hover:scale-110 transition-transform cursor-pointer group">
                                <div className="w-8 h-5 bg-black/30 rounded-md flex justify-around items-center px-1 backdrop-blur-sm">
                                    <div className="w-1.5 h-1.5 bg-cyan-400 rounded-full animate-blink"></div>
                                    <div className="w-1.5 h-1.5 bg-cyan-400 rounded-full animate-blink" style={{animationDelay: '75ms'}}></div>
                                </div>
                                <div className="absolute -bottom-1 w-3 h-1 bg-black/20 rounded-full blur-sm"></div>
                            </div>
                        )}
                    </div>
             );
        };

        // --- Main App ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [query, setQuery] = useState('');
            // Use SourceCategory Enum for state
            const [activeSource, setActiveSource] = useState(SourceCategory.ALL);
            const [activeGenre, setActiveGenre] = useState(Genre.ALL);
            
            // Refactored BorrowedBooks to store Object with loan details instead of just Set of IDs
            // Structure: { [bookId]: { borrowDate, dueDate, courseCode } }
            const [borrowedBooks, setBorrowedBooks] = useState({});
            
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            // App State
            const [isOnline, setIsOnline] = useState(typeof navigator !== 'undefined' ? navigator.onLine : true);
            const [theme, setTheme] = useState('dark');
            const [showNotifPanel, setShowNotifPanel] = useState(false);

            // Modal States
            const [renewModalOpen, setRenewModalOpen] = useState(false);
            const [bookingModalOpen, setBookingModalOpen] = useState(false);
            const [profileOpen, setProfileOpen] = useState(false);
            const [feedbackOpen, setFeedbackOpen] = useState(false);
            const [selectedBook, setSelectedBook] = useState(null);
            const [selectedRoom, setSelectedRoom] = useState(null);
            
            // Data States
            const [onlineBooks, setOnlineBooks] = useState([]);
            const [notifications, setNotifications] = useState([]);
            // Notification History (Persistent)
            const [allNotifications, setAllNotifications] = useState([]);

            const [rooms, setRooms] = useState([
                { id: 1, name: 'Discussion Room 1', capacity: 4, status: 'Available' },
                { id: 2, name: 'Discussion Room 2', capacity: 6, status: 'Occupied' },
                { id: 3, name: 'Discussion Room 3', capacity: 4, status: 'Available' },
                { id: 4, name: 'Discussion Room 4', capacity: 6, status: 'Occupied' },
                { id: 5, name: 'Studio Room', capacity: 10, status: 'Available' },
                { id: 6, name: 'Auditorium', capacity: 50, status: 'Available' }
            ]);

            // Theme Effect
            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [theme]);
            
            // Network Listener
            useEffect(() => {
                const handleOnline = () => { setIsOnline(true); addNotification("You are back Online"); };
                const handleOffline = () => { setIsOnline(false); addNotification("You are now Offline"); };
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            const toggleOnline = () => {
                setIsOnline(prev => {
                    const newState = !prev;
                    addNotification(newState ? "You are back Online" : "You are now Offline");
                    return newState;
                });
            };

            const handleLogin = (u) => {
                setUser(u);
                addNotification("Welcome to PTAR Nexus!");
            };
            const handleLogout = () => setUser(null);

            const addNotification = (msg) => {
                const id = Date.now();
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                // Temporary Toast
                setNotifications(prev => [...prev, { id, msg }]);
                // Persistent History
                setAllNotifications(prev => [{ msg, time }, ...prev]);
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== id));
                }, 3000);
            };
            
            const handleScanSuccess = () => {
                const scanTime = new Date().toLocaleString();
                addNotification("Welcome to PTAR Library UiTM Samarahan 1");
            };

            const toggleMobileMenu = () => setMobileMenuOpen(!mobileMenuOpen);

            // Open Library API Logic
            useEffect(() => {
                const controller = new AbortController();
                const fetchBooks = async () => {
                    if (!isOnline) return; // Don't fetch if offline
                    try {
                        let searchTerm = query;
                        // If no specific query is entered, we use the active genre to fetch relevant books
                        if (!searchTerm) {
                            if (activeGenre === Genre.ALL) {
                                // Default broad search if ALL is selected
                                searchTerm = 'trending'; 
                            } else {
                                switch(activeGenre) {
                                    case Genre.TECH: searchTerm = 'technology'; break;
                                    case Genre.BUSINESS: searchTerm = 'business'; break;
                                    case Genre.FICTION: searchTerm = 'fiction'; break;
                                    case Genre.SCIENCE: searchTerm = 'science'; break;
                                    case Genre.HISTORY: searchTerm = 'history'; break;
                                    case Genre.LAW: searchTerm = 'law'; break;
                                    case Genre.ART: searchTerm = 'art'; break;
                                    default: searchTerm = 'popular'; break;
                                }
                            }
                        }
                        
                        // Fetching...
                        const res = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(searchTerm)}&limit=16`, {
                            signal: controller.signal
                        });
                        
                        if (!res.ok) throw new Error('API Error');

                        const data = await res.json();
                        const mapped = (data.docs || []).map(doc => ({
                            id: doc.key,
                            title: doc.title,
                            author: doc.author_name?.[0] || 'Unknown',
                            year: doc.first_publish_year || 'N/A',
                            type: ResourceType.EBOOK,
                            source: SourceCategory.GLOBAL, // Explicitly tag as GLOBAL
                            genre: activeGenre, 
                            coverImage: doc.cover_i ? `https://covers.openlibrary.org/b/id/${doc.cover_i}-M.jpg` : GENERIC_COVER,
                            // Improved Summary Fallback
                            summary: doc.first_sentence?.[0] || `An edition of ${doc.title} (${doc.first_publish_year}). Access this global resource online via Open Library.`
                        }));
                        setOnlineBooks(mapped);
                    } catch(e) { 
                        if (e.name !== 'AbortError') {
                            // Silently fail or log for debug
                            console.log("Fetch failed or cancelled");
                            // Don't clear online books entirely on error to prevent flashing, but could handle more gracefully
                        }
                    }
                };
                
                // Fetch on query change, genre change, or if we switched to ALL/Search tab
                // Also trigger initially or when source changes
                if (true) { // Always try to keep list populated
                     const timeout = setTimeout(fetchBooks, 500);
                     return () => {
                         clearTimeout(timeout);
                         controller.abort();
                     };
                }
                return () => controller.abort();
            }, [query, activeSource, activeTab, activeGenre, isOnline]);

            // Interaction Handlers
            const handleBookClick = (book) => {
                setSelectedBook(book);
                setRenewModalOpen(true);
            };

            const toggleBorrow = (book) => {
                // Now opens the Modal instead of instant toggle
                handleBookClick(book);
            };
            
            const handleBorrow = (book, details) => {
                // Update borrowedBooks state with details
                setBorrowedBooks(prev => ({
                    ...prev,
                    [book.id]: {
                        borrowDate: getISODate(),
                        dueDate: details.returnDate,
                        courseCode: details.courseCode
                    }
                }));
                addNotification(`Borrowed: ${book.title}`);
                setRenewModalOpen(false);
            };

            const handleRenew = (book) => {
                 setBorrowedBooks(prev => ({
                    ...prev,
                    [book.id]: {
                        ...prev[book.id],
                        dueDate: getISODate(7) // Extend by 7 days from today simplistically
                    }
                }));
                addNotification(`Renewed: ${book.title}`);
                setRenewModalOpen(false);
            };

            const handleReturn = (book) => {
                const newBorrowed = { ...borrowedBooks };
                delete newBorrowed[book.id];
                setBorrowedBooks(newBorrowed);
                addNotification(`Returned: ${book.title}`);
                setRenewModalOpen(false);
            };

            const handleRoomClick = (room) => {
                if (room.status === 'Available') {
                    setSelectedRoom(room);
                    setBookingModalOpen(true);
                } else {
                    addNotification("Room is currently occupied.");
                }
            };

            const confirmBooking = (room, slot) => {
                setRooms(prev => prev.map(r => r.id === room.id ? {...r, status: 'Occupied'} : r));
                setBookingModalOpen(false);
                addNotification(`Booked ${room.name} for ${slot}`);
            };

            const handleFeedbackSubmit = (type, desc) => {
                setFeedbackOpen(false);
                addNotification("Feedback Submitted. Thank you!");
            };

            if (!user) return <LoginScreen onLogin={handleLogin} />;

            // Merge Local & Online for display
            const allResources = [...localPhysicalInventory, ...localDigitalInventory, ...(isOnline ? onlineBooks : [])];
            
            // Source Filter Definition - Rearranged as requested
            const sourceFilters = [
                { id: SourceCategory.ALL, label: 'All Sources', icon: 'fa-layer-group' },
                { id: SourceCategory.UITM_PHYSICAL, label: 'UiTM Physical Collection', icon: 'fa-book' },
                { id: SourceCategory.UITM_DIGITAL, label: 'UiTM Digital Archive', icon: 'fa-server' },
                { id: SourceCategory.GLOBAL, label: 'Global Online Resources (Open Library)', icon: 'fa-globe' }
            ];

            const displayBooks = allResources.filter(b => {
                    const matchQuery = !query || b.title.toLowerCase().includes(query.toLowerCase());
                    
                    // Robust Source Filtering
                    let matchSource = false;
                    if (activeSource === SourceCategory.ALL) matchSource = true;
                    else if (activeSource === b.source) matchSource = true;

                    const matchGenre = activeGenre === Genre.ALL || b.genre === activeGenre;
                    
                    return matchQuery && matchSource && matchGenre;
            });

            return (
                <div className="flex h-screen w-screen bg-gray-100 dark:bg-[#0f1016] overflow-hidden transition-colors duration-300">
                    {/* Mobile Overlay */}
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 bg-black/80 z-40 lg:hidden" onClick={() => setMobileMenuOpen(false)}></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 w-64 bg-white dark:bg-[#0f1016] border-r border-gray-200 dark:border-white/5 flex flex-col z-50 transform transition-transform duration-300 lg:translate-x-0 lg:static ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="h-16 md:h-20 flex items-center px-6 border-b border-gray-200 dark:border-white/5 lg:border-none">
                            <div className="w-8 h-8 bg-gradient-to-br from-pink-500 to-purple-600 rounded-lg flex items-center justify-center mr-3 shadow-lg shadow-purple-900/30"><i className="fa-solid fa-layer-group text-white text-sm"></i></div>
                            <span className="text-slate-800 dark:text-white font-bold text-lg tracking-wide">PTAR <span className="text-purple-600 dark:text-purple-400">NEXUS</span></span>
                            <button onClick={() => setMobileMenuOpen(false)} className="ml-auto lg:hidden text-slate-400"><i className="fa-solid fa-xmark"></i></button>
                        </div>
                        <nav className="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                            {[
                                { id: 'dashboard', icon: 'fa-table-columns', label: 'Dashboard' },
                                { id: 'search', icon: 'fa-magnifying-glass', label: 'Search' },
                                { id: 'booking', icon: 'fa-people-roof', label: 'Room Booking' },
                                { id: 'id', icon: 'fa-id-card', label: 'My Digital ID' },
                                { id: 'analytics', icon: 'fa-chart-line', label: 'Analytics' },
                            ].map(item => (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setMobileMenuOpen(false); }} className={`w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 ${activeTab === item.id ? 'bg-gradient-to-r from-purple-600 to-fuchsia-600 text-white shadow-lg shadow-purple-900/20' : 'text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-white hover:bg-purple-50 dark:hover:bg-white/5'}`}>
                                    <i className={`fa-solid ${item.icon} w-6`}></i> {item.label}
                                </button>
                            ))}
                            {/* Feedback Button in Sidebar */}
                             <button onClick={() => { setFeedbackOpen(true); setMobileMenuOpen(false); }} className={`w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-white hover:bg-purple-50 dark:hover:bg-white/5`}>
                                <i className={`fa-solid fa-comment-dots w-6`}></i> Feedback
                            </button>
                        </nav>
                        <div className="p-4 border-t border-gray-200 dark:border-white/5">
                            <button onClick={handleLogout} className="w-full flex items-center px-4 py-3 text-red-500 hover:text-red-600 dark:hover:text-red-400 transition-colors text-sm font-medium hover:bg-red-50 dark:hover:bg-red-500/5 rounded-xl"><i className="fa-solid fa-arrow-right-from-bracket w-6"></i> Logout</button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col relative overflow-hidden w-full">
                        {/* Background Effects */}
                        <div className="absolute top-0 left-0 w-full h-[500px] bg-gradient-to-b from-purple-900/5 dark:from-purple-900/10 to-transparent pointer-events-none"></div>
                        
                        <Header 
                            user={user} 
                            toggleMobileMenu={toggleMobileMenu} 
                            onOpenProfile={() => setProfileOpen(true)} 
                            notifications={notifications} 
                            isOnline={isOnline} 
                            toggleOnline={toggleOnline}
                            theme={theme}
                            toggleTheme={toggleTheme}
                            onToggleNotifications={() => setShowNotifPanel(!showNotifPanel)}
                            showNotifPanel={showNotifPanel}
                            allNotifications={allNotifications}
                        />
                        
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 scrollbar-hide relative z-10 touch-scroll">
                            {/* Dashboard View */}
                            {activeTab === 'dashboard' && (
                                <div className="max-w-7xl mx-auto space-y-6 md:space-y-8 animate-fade-in">
                                    {/* Widgets Row - Responsive Grid */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4 md:gap-6 lg:h-96">
                                        <div className="lg:col-span-3 h-64 md:h-full"><DigitalIDWidget user={user} onScan={handleScanSuccess} enableScan={false} /></div>
                                        <div className="lg:col-span-5 h-80 md:h-full"><SmartBookingWidget rooms={rooms} onBookClick={handleRoomClick} /></div>
                                        <div className="md:col-span-2 lg:col-span-4 h-64 md:h-full"><AnalyticsWidget /></div>
                                    </div>

                                    {/* NEW: Trending & News Row */}
                                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 h-auto lg:h-72">
                                        <div className="lg:col-span-8 h-64 lg:h-full"><TrendingBooksWidget onBookClick={handleBookClick}/></div>
                                        <div className="lg:col-span-4 h-64 lg:h-full"><NewsFeedWidget /></div>
                                    </div>
                                    
                                </div>
                            )}

                            {activeTab === 'search' && (
                                <div className="max-w-7xl mx-auto animate-fade-in">
                                    <h2 className="text-xl md:text-2xl font-bold text-slate-800 dark:text-white mb-2">Search Resources</h2>
                                    <p className="text-slate-500 dark:text-slate-400 text-xs md:text-sm mb-6">Access Open Library & Physical Resources.</p>
                                    
                                    {/* Search Input Moved Here */}
                                    <div className="relative mb-6">
                                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i className="fa-solid fa-magnifying-glass text-slate-400 dark:text-slate-500"></i></div>
                                        <input type="text" value={query} onChange={e => setQuery(e.target.value)} className="w-full bg-white dark:bg-[#1e2030]/80 border border-gray-200 dark:border-white/10 rounded-xl py-3 md:py-4 pl-12 pr-4 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:border-purple-500 transition-all shadow-xl backdrop-blur-sm focus:ring-1 focus:ring-purple-500/50 text-sm md:text-base" placeholder="Search by Title, Author, or Call Number..." />
                                    </div>

                                    {/* Source Filters - Updated Structure & Reset Logic */}
                                    <div className="flex flex-wrap gap-2 md:gap-3 mb-4">
                                            {sourceFilters.map((s, i) => {
                                                const isActive = activeSource === s.id;
                                                return (
                                                    <button 
                                                        key={s.id} 
                                                        onClick={() => {
                                                            setActiveSource(s.id);
                                                        }} 
                                                        className={`px-3 py-2 md:px-4 md:py-2 rounded-lg text-[10px] md:text-xs font-bold border transition-all flex items-center gap-2 ${isActive ? 'bg-slate-800 dark:bg-slate-700 text-white border-transparent shadow-md' : 'bg-white dark:bg-[#181926] text-slate-500 dark:text-slate-400 border-gray-200 dark:border-white/5 hover:border-purple-500/50'}`}
                                                    >
                                                        <i className={`fa-solid ${s.icon}`}></i> {s.label}
                                                    </button>
                                                )
                                            })}
                                    </div>
                                    
                                    {/* Genre Filters - Modified to allow "Reset" via All Resources */}
                                    <div className="flex flex-nowrap overflow-x-auto gap-2 mb-8 pb-2 scrollbar-hide">
                                        {Object.values(Genre).map(g => (
                                            <button 
                                                key={g} 
                                                onClick={() => {
                                                    setActiveGenre(g);
                                                    if(g === Genre.ALL) {
                                                        // Explicitly clear query to reset the view when "All Resources" is clicked
                                                        setQuery(''); 
                                                    }
                                                }} 
                                                className={`flex-shrink-0 px-4 py-1.5 rounded-full border text-xs font-bold transition-all ${activeGenre === g ? 'bg-purple-600 text-white border-purple-500 shadow-lg' : 'bg-white dark:bg-[#181926] border-gray-200 dark:border-white/5 text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-white hover:border-purple-500/30'}`}
                                            >
                                                {g}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-10">
                                        {displayBooks.map((book, idx) => (
                                            <ResultCard key={book.id || idx} result={book} isBorrowed={!!borrowedBooks[book.id]} onBookClick={handleBookClick} onToggleBorrow={() => toggleBorrow(book)} onRead={() => handleBookClick(book)} idx={idx} />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'booking' && (
                                <div className="max-w-4xl mx-auto h-[calc(100vh-140px)] animate-fade-in">
                                     <SmartBookingWidget rooms={rooms} onBookClick={handleRoomClick} />
                                </div>
                            )}
                            
                            {activeTab === 'id' && (
                                <div className="max-w-sm mx-auto mt-10 md:mt-20 h-96 animate-fade-in">
                                     <DigitalIDWidget user={user} onScan={handleScanSuccess} enableScan={true} />
                                </div>
                            )}
                            
                             {activeTab === 'analytics' && (
                                <div className="max-w-4xl mx-auto mt-6 md:mt-10 h-80 md:h-96 animate-fade-in">
                                     <AnalyticsWidget />
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Modals & Chatbot */}
                    <ChatbotWidget />
                    <BorrowReturnModal 
                        book={selectedBook} 
                        isOpen={renewModalOpen} 
                        onClose={() => setRenewModalOpen(false)} 
                        onBorrow={handleBorrow} 
                        onRenew={handleRenew}
                        onReturn={handleReturn}
                        isBorrowed={!!(selectedBook && borrowedBooks[selectedBook.id])}
                        borrowedDetails={selectedBook ? borrowedBooks[selectedBook.id] : null}
                        user={user}
                    />
                    <BookingDetailModal room={selectedRoom} user={user} isOpen={bookingModalOpen} onClose={() => setBookingModalOpen(false)} onConfirm={confirmBooking} />
                    <ProfileModal user={user} isOpen={profileOpen} onClose={() => setProfileOpen(false)} />
                    <FeedbackModal isOpen={feedbackOpen} onClose={() => setFeedbackOpen(false)} onSubmit={handleFeedbackSubmit} />
                    
                    {/* Notifications Overlay */}
                    <div className="fixed top-24 right-4 md:right-6 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-[320px]">
                        {notifications.map((notif) => (
                            <div key={notif.id} className="bg-white dark:bg-[#181926] border border-green-500/30 text-slate-800 dark:text-green-400 px-4 py-3 rounded-xl shadow-2xl animate-slide-in-left flex items-center gap-3 backdrop-blur-md">
                                <i className="fa-solid fa-circle-check text-green-500"></i>
                                <span className="text-xs md:text-sm font-bold">{notif.msg}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>